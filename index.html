<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>年度业务数据管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#A23B72',      // 主色调：优雅的紫红色
                        secondary: '#2E86AB',    // 辅助色：专业的蓝色
                        accent: '#F18F01',       // 强调色：温暖的橙色
                        neutral: '#F8F5F2',      // 中性色：柔和的米色背景
                        'neutral-dark': '#333333' // 深色文本
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .cell-transition {
                transition: all 0.2s ease;
            }
            .btn-hover {
                @apply transform hover:scale-105 transition-transform duration-200;
            }
            .card-hover {
                @apply hover:shadow-lg transition-shadow duration-300;
            }
            .month-active {
                @apply bg-primary text-white;
            }
            .form-input {
                @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary;
            }
            .rank-badge {
                @apply w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white;
            }
            .hide-scrollbar::-webkit-scrollbar {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-neutral min-h-screen text-neutral-dark">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-md sticky top-0 z-50 transition-all duration-300">
        <div class="container mx-auto px-4 py-4 flex flex-wrap items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fa fa-calendar-check-o text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-primary">年度业务数据管理系统</h1>
            </div>
            
            <div class="flex items-center space-x-4 mt-2 md:mt-0 flex-wrap justify-center">
                <button id="importBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg btn-hover flex items-center">
                    <i class="fa fa-upload mr-2"></i>导入数据
                </button>
                <button id="exportCurrentBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg btn-hover flex items-center">
                    <i class="fa fa-download mr-2"></i>导出当月
                </button>
                <button id="exportAllBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg btn-hover flex items-center">
                    <i class="fa fa-download mr-2"></i>导出全年
                </button>
                <button id="staffBtn" class="bg-accent hover:bg-accent/90 text-white px-4 py-2 rounded-lg btn-hover flex items-center">
                    <i class="fa fa-user-plus mr-2"></i>员工管理
                </button>
                <button id="saveBtn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg btn-hover flex items-center">
                    <i class="fa fa-save mr-2"></i>保存数据
                </button>
            </div>
        </div>
    </header>

    <!-- 月份选择器 -->
    <div class="bg-white border-b">
        <div class="container mx-auto px-4">
            <div class="flex overflow-x-auto py-3 space-x-2 hide-scrollbar">
                <button class="month-btn px-4 py-2 rounded-full text-sm whitespace-nowrap month-active" data-month="1">1月</button>
                <button class="month-btn px-4 py-2 rounded-full text-sm whitespace-nowrap bg-gray-100 hover:bg-gray-200" data-month="2">2月</button>
                <button class="month-btn px-4 py-2 rounded-full text-sm whitespace-nowrap bg-gray-100 hover:bg-gray-200" data-month="3">3月</button>
                <button class="month-btn px-4 py-2 rounded-full text-sm whitespace-nowrap bg-gray-100 hover:bg-gray-200" data-month="4">4月</button>
                <button class="month-btn px-4 py-2 rounded-full text-sm whitespace-nowrap bg-gray-100 hover:bg-gray-200" data-month="5">5月</button>
                <button class="month-btn px-4 py-2 rounded-full text-sm whitespace-nowrap bg-gray-100 hover:bg-gray-200" data-month="6">6月</button>
                <button class="month-btn px-4 py-2 rounded-full text-sm whitespace-nowrap bg-gray-100 hover:bg-gray-200" data-month="7">7月</button>
                <button class="month-btn px-4 py-2 rounded-full text-sm whitespace-nowrap bg-gray-100 hover:bg-gray-200" data-month="8">8月</button>
                <button class="month-btn px-4 py-2 rounded-full text-sm whitespace-nowrap bg-gray-100 hover:bg-gray-200" data-month="9">9月</button>
                <button class="month-btn px-4 py-2 rounded-full text-sm whitespace-nowrap bg-gray-100 hover:bg-gray-200" data-month="10">10月</button>
                <button class="month-btn px-4 py-2 rounded-full text-sm whitespace-nowrap bg-gray-100 hover:bg-gray-200" data-month="11">11月</button>
                <button class="month-btn px-4 py-2 rounded-full text-sm whitespace-nowrap bg-gray-100 hover:bg-gray-200" data-month="12">12月</button>
            </div>
        </div>
    </div>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 数据概览卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">本月记录</p>
                        <h3 class="text-3xl font-bold mt-1" id="monthRecords">0</h3>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
                        <i class="fa fa-list-alt text-primary text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 text-sm text-green-600 flex items-center">
                    <i class="fa fa-check-circle mr-1"></i> 当前月份
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">本月客户</p>
                        <h3 class="text-3xl font-bold mt-1" id="monthCustomers">0</h3>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-secondary/10 flex items-center justify-center">
                        <i class="fa fa-users text-secondary text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 text-sm text-gray-500 flex items-center">
                    <i class="fa fa-user mr-1"></i> 已去重统计
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">客户总数</p>
                        <h3 class="text-3xl font-bold mt-1" id="totalCustomers">0</h3>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                        <i class="fa fa-user-circle text-blue-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 text-sm text-gray-500 flex items-center">
                    <i class="fa fa-users mr-1"></i> 全年去重统计
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">服务次数</p>
                        <h3 class="text-3xl font-bold mt-1" id="totalServices">300+</h3>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-accent/10 flex items-center justify-center">
                        <i class="fa fa-hand-paper-o text-accent text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 text-sm text-gray-500 flex items-center">
                    <i class="fa fa-clock-o mr-1"></i> 本月统计
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">月营业额</p>
                        <h3 class="text-3xl font-bold mt-1" id="monthRevenue">¥0</h3>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                        <i class="fa fa-money text-green-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 text-sm text-green-600 flex items-center" id="monthRevenueChange">
                    <i class="fa fa-arrow-up mr-1"></i> 较上月增长0%
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">年总营业额</p>
                        <h3 class="text-3xl font-bold mt-1" id="yearRevenue">¥0</h3>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center">
                        <i class="fa fa-line-chart text-purple-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 text-sm text-purple-600 flex items-center">
                    <i class="fa fa-calendar mr-1"></i> 全年累计
                </div>
            </div>
        </div>
        
        <!-- 客户年消费分析 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow card-hover lg:col-span-2">
                <h3 class="text-lg font-bold mb-4">客户年度消费排名</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">排名</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">客户名称</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">总消费</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">到店次数</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">平均消费</th>
                            </tr>
                        </thead>
                        <tbody id="customerRankingBody">
                            <!-- 动态填充 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow card-hover">
                <h3 class="text-lg font-bold mb-4">Top5客户消费占比</h3>
                <div class="h-64">
                    <canvas id="topCustomersChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- 美容师月度业绩统计 -->
        <div class="bg-white rounded-xl p-6 shadow mb-8 card-hover">
            <h3 class="text-lg font-bold mb-4">美容师月度业绩统计</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">美容师</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">总手工费</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">总业绩</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">服务次数</th>
                        </tr>
                    </thead>
                    <tbody id="beauticianStatsBody">
                        <!-- 动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 图表区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow card-hover">
                <h3 class="text-lg font-bold mb-4">业务类型分布</h3>
                <div class="h-64">
                    <canvas id="serviceTypeChart"></canvas>
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow card-hover">
                <h3 class="text-lg font-bold mb-4">月度营业额趋势</h3>
                <div class="h-64">
                    <canvas id="monthlyTrendChart"></canvas>
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow card-hover">
                <h3 class="text-lg font-bold mb-4">到点途径分布</h3>
                <div class="h-64">
                    <canvas id="arrivalChannelChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- 表格控制区 -->
        <div class="bg-white rounded-xl p-4 shadow mb-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center">
                    <button id="addRowBtn" class="bg-secondary hover:bg-secondary/90 text-white px-4 py-2 rounded-lg btn-hover flex items-center">
                        <i class="fa fa-plus mr-2"></i>新增记录
                    </button>
                </div>
                
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="搜索记录..." 
                           class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary w-full md:w-64">
                    <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
        </div>
        
        <!-- 表格容器 -->
        <div class="bg-white rounded-xl shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">日期</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">客户名称</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">服务项目</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">美容师</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">到点途径</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">手工费</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">业绩</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">金额</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">操作</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- 动态填充 -->
                    </tbody>
                </table>
            </div>
            
            <!-- 分页控件 -->
            <div class="px-4 py-3 flex items-center justify-between border-t">
                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                        <p class="text-sm text-gray-700">
                            显示第 <span id="currentPageRange">1 到 0</span> 条，共 <span id="totalItems">0</span> 条记录
                        </p>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            <button id="prevPage" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">上一页</span>
                                <i class="fa fa-chevron-left"></i>
                            </button>
                            <div id="paginationNumbers" class="flex">
                                <!-- 动态填充页码 -->
                            </div>
                            <button id="nextPage" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">下一页</span>
                                <i class="fa fa-chevron-right"></i>
                            </button>
                        </nav>
                    </div>
                </div>
                
                <!-- 移动端分页 -->
                <div class="flex items-center justify-between w-full sm:hidden">
                    <button id="prevPageMobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        上一页
                    </button>
                    <button id="nextPageMobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        下一页
                    </button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- 页脚 -->
    <footer class="bg-white border-t mt-12 py-6">
        <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
            <p>© 2023 美容养生业务管理系统 | 数据管理与分析平台</p>
        </div>
    </footer>
    
    <!-- 员工管理模态框 -->
    <div id="staffModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-neutral-dark">员工管理</h3>
                    <button id="closeStaffModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <h4 class="font-medium mb-2">美容师/理疗师列表</h4>
                    <ul id="staffList" class="max-h-60 overflow-y-auto">
                        <!-- 动态填充 -->
                    </ul>
                </div>
                
                <button id="addStaffBtn" class="w-full bg-secondary hover:bg-secondary/90 text-white px-4 py-2 rounded-lg btn-hover flex items-center justify-center">
                    <i class="fa fa-plus mr-2"></i>添加员工
                </button>
                
                <form id="staffForm" class="space-y-4 hidden mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">员工姓名 <span class="text-red-500">*</span></label>
                        <input type="text" id="staffName" class="form-input" placeholder="请输入员工姓名" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">职位 <span class="text-red-500">*</span></label>
                        <select id="staffPosition" class="form-input" required>
                            <option value="美容师">美容师</option>
                            <option value="理疗师">理疗师</option>
                        </select>
                    </div>
                    
                    <div class="flex space-x-3 pt-2">
                        <button type="button" id="cancelStaffBtn" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 btn-hover">取消</button>
                        <button type="button" id="saveStaffBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg btn-hover">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 记录编辑模态框 -->
    <div id="recordModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-200">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 id="recordModalTitle" class="text-xl font-bold text-neutral-dark">新增业务记录</h3>
                    <button id="closeRecordModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <form id="recordForm" class="space-y-5">
                    <input type="hidden" id="recordIndex" value="-1">
                    <input type="hidden" id="recordMonth" value="">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">日期 <span class="text-red-500">*</span></label>
                            <input type="date" id="recordDate" class="form-input" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">客户名称 <span class="text-red-500">*</span></label>
                            <input type="text" id="recordCustomer" class="form-input" placeholder="请输入客户姓名" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">服务项目 <span class="text-red-500">*</span></label>
                        <input type="text" id="recordProject" class="form-input" placeholder="请输入服务项目，多个项目用逗号分隔" required>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">美容师 <span class="text-red-500">*</span></label>
                            <select id="recordBeautician" class="form-input" required>
                                <option value="">请选择美容师</option>
                                <!-- 动态填充美容师列表 -->
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">到点途径 <span class="text-red-500">*</span></label>
                            <select id="recordChannel" class="form-input" required>
                                <option value="">请选择到点途径</option>
                                <option value="会员">会员</option>
                                <option value="抖音">抖音</option>
                                <option value="美团">美团</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">手工费</label>
                            <input type="number" step="0.01" id="recordManualFee" class="form-input" placeholder="0.00">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">业绩</label>
                            <input type="number" step="0.01" id="recordPerformance" class="form-input" placeholder="0.00">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">金额 <span class="text-red-500">*</span></label>
                            <input type="number" step="0.01" id="recordAmount" class="form-input" placeholder="0.00" required>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" id="cancelRecordBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 btn-hover">取消</button>
                        <button type="submit" id="saveRecordBtn" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg btn-hover">保存记录</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 导入数据模态框 -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-neutral-dark">导入数据</h3>
                    <button id="closeImportModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-4">请上传CSV格式的数据文件，文件需包含以下列（顺序不限）：</p>
                    <ul class="text-sm text-gray-500 space-y-1 mb-4">
                        <li>• 月份 (1-12)</li>
                        <li>• 日期 (格式：日，如：5 或 15)</li>
                        <li>• 客户名称</li>
                        <li>• 服务项目</li>
                        <li>• 美容师</li>
                        <li>• 到点途径</li>
                        <li>• 手工费</li>
                        <li>• 业绩</li>
                        <li>• 金额</li>
                    </ul>
                    
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors cursor-pointer" id="dropArea">
                        <i class="fa fa-file-text-o text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-500">拖放CSV文件到此处，或<span class="text-primary">点击上传</span></p>
                        <input type="file" id="fileInput" accept=".csv" class="hidden">
                    </div>
                </div>
                
                <div id="importProgress" class="hidden mb-4">
                    <div class="text-sm font-medium text-gray-700 mb-1">导入进度</div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progressBar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="importStatus" class="text-xs text-gray-500 mt-1">准备导入...</p>
                </div>
                
                <button id="confirmImportBtn" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg btn-hover flex items-center justify-center hidden">
                    <i class="fa fa-check mr-2"></i>确认导入
                </button>
            </div>
        </div>
    </div>
    
    <!-- 通知提示框 -->
    <div id="notification" class="fixed bottom-6 right-6 px-6 py-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center max-w-xs">
        <i id="notificationIcon" class="fa fa-check-circle mr-3 text-xl"></i>
        <span id="notificationText">操作成功</span>
    </div>

    <script>
        // 从本地存储加载数据或初始化
        let staffData = JSON.parse(localStorage.getItem('staffData')) || [
            { id: 1, name: "阳阳", position: "美容师" },
            { id: 2, name: "董董", position: "理疗师" },
            { id: 3, name: "莉莉", position: "美容师" },
            { id: 4, name: "梦梦", position: "理疗师" }
        ];
        
        // 到点途径选项
        const arrivalChannels = ["会员", "抖音", "美团"];
        
        // 从本地存储加载数据或初始化
        let yearBusinessData = JSON.parse(localStorage.getItem('yearBusinessData')) || {
            1: [
                { "日期": "1.5", "客户名称": "张女士", "项目": "面部护理", "美容师": "阳阳", "到点途径": "会员", "手工费": 15.0, "业绩": 380.0, "金额": 380.0 },
                { "日期": "1.8", "客户名称": "李女士", "项目": "肩颈理疗", "美容师": "董董", "到点途径": "美团", "手工费": 20.0, "业绩": 480.0, "金额": 480.0 },
            ],
            10: [
                { "日期": "10.1", "客户名称": "王彬", "项目": "面部拨筋，艾灸肚子", "美容师": "阳阳", "到点途径": "会员", "手工费": 10.0, "业绩": null, "金额": 580.0 },
            ]
        };
        
        // 初始化月份数据
        for (let i = 1; i <= 12; i++) {
            if (!yearBusinessData[i]) {
                yearBusinessData[i] = [];
            }
        }
        
        // 临时存储导入的数据
        let importedData = [];
        
        // 当前选中的月份
        let currentMonth = new Date().getMonth() + 1;
        // 当前页码
        let currentPage = 1;
        // 每页显示数量
        const pageSize = 10;
        // 搜索关键词
        let searchKeyword = '';
        
        // DOM 加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化月份选择
            updateMonthView(currentMonth);
            
            // 初始化员工列表
            renderStaffList();
            populateBeauticianSelects();
            
            // 初始化图表
            initCharts();
            
            // 绑定所有事件
            bindAllEvents();
            
            // 修复：确保月份按钮事件正确绑定
            rebindMonthButtons();
        });
        
        // 重新绑定月份按钮事件（修复月份切换问题）
        function rebindMonthButtons() {
            // 先移除所有已存在的事件监听器
            document.querySelectorAll('.month-btn').forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
            });
            
            // 重新绑定事件
            document.querySelectorAll('.month-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const month = parseInt(this.dataset.month);
                    if (month !== currentMonth) {
                        updateMonthView(month);
                        showNotification('success', `已切换到${month}月份数据`);
                    }
                });
            });
        }
        
        // 绑定所有事件处理程序
        function bindAllEvents() {
            // 月份切换按钮事件（已在rebindMonthButtons中处理）
            
            // 新增记录按钮事件
            document.getElementById('addRowBtn').addEventListener('click', function() {
                openRecordModal(-1); // -1 表示新增记录
            });
            
            // 记录表单事件
            bindRecordFormEvents();
            
            // 分页事件
            bindPaginationEvents();
            
            // 搜索事件
            bindSearchEvent();
            
            // 员工管理事件
            bindStaffManagementEvents();
            
            // 保存数据按钮事件
            bindSaveDataButton();
            
            // 导入导出事件
            bindImportExportEvents();
        }
        
        // 绑定导入导出事件
        function bindImportExportEvents() {
            // 导出当前月份数据
            document.getElementById('exportCurrentBtn').addEventListener('click', function() {
                exportData(currentMonth);
            });
            
            // 导出全年数据
            document.getElementById('exportAllBtn').addEventListener('click', function() {
                exportAllData();
            });
            
            // 导入数据相关事件
            const importBtn = document.getElementById('importBtn');
            const importModal = document.getElementById('importModal');
            const closeImportModal = document.getElementById('closeImportModal');
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('fileInput');
            const confirmImportBtn = document.getElementById('confirmImportBtn');
            
            // 打开导入模态框
            importBtn.addEventListener('click', function() {
                importModal.classList.remove('hidden');
                resetImportModal();
            });
            
            // 关闭导入模态框
            closeImportModal.addEventListener('click', function() {
                importModal.classList.add('hidden');
                resetImportModal();
            });
            
            // 点击上传区域触发文件选择
            dropArea.addEventListener('click', function() {
                fileInput.click();
            });
            
            // 文件选择变化时处理
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length) {
                    handleFileUpload(e.target.files[0]);
                }
            });
            
            // 拖放功能
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.classList.add('border-primary', 'bg-primary/5');
            }
            
            function unhighlight() {
                dropArea.classList.remove('border-primary', 'bg-primary/5');
            }
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            }
            
            // 确认导入
            confirmImportBtn.addEventListener('click', function() {
                processImportedData();
            });
        }
        
        // 处理文件上传
        function handleFileUpload(file) {
            if (!file.name.endsWith('.csv')) {
                showNotification('error', '请上传CSV格式的文件');
                return;
            }
            
            const reader = new FileReader();
            const importProgress = document.getElementById('importProgress');
            const progressBar = document.getElementById('progressBar');
            const importStatus = document.getElementById('importStatus');
            const confirmImportBtn = document.getElementById('confirmImportBtn');
            
            // 显示进度条
            importProgress.classList.remove('hidden');
            progressBar.style.width = '30%';
            importStatus.textContent = '正在解析文件...';
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n');
                    if (lines.length < 2) {
                        throw new Error('文件内容为空或格式不正确');
                    }
                    
                    // 解析表头
                    const headers = lines[0].split(',').map(header => header.trim().toLowerCase());
                    
                    // 检查必要的列
                    const requiredColumns = ['月份', '日期', '客户名称', '服务项目', '美容师', '到点途径', '金额'];
                    const missingColumns = requiredColumns.filter(col => 
                        !headers.some(header => header.includes(col.toLowerCase()))
                    );
                    
                    if (missingColumns.length > 0) {
                        throw new Error(`缺少必要的列：${missingColumns.join(', ')}`);
                    }
                    
                    // 解析数据行
                    importedData = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        
                        const values = lines[i].split(',').map(val => val.trim());
                        const row = {};
                        
                        headers.forEach((header, index) => {
                            if (header.includes('月份')) row.month = values[index];
                            else if (header.includes('日期')) row.day = values[index];
                            else if (header.includes('客户名称')) row.customer = values[index];
                            else if (header.includes('服务项目')) row.project = values[index];
                            else if (header.includes('美容师')) row.beautician = values[index];
                            else if (header.includes('到点途径')) row.channel = values[index];
                            else if (header.includes('手工费')) row.manualFee = values[index];
                            else if (header.includes('业绩')) row.performance = values[index];
                            else if (header.includes('金额')) row.amount = values[index];
                        });
                        
                        importedData.push(row);
                    }
                    
                    // 更新进度
                    progressBar.style.width = '80%';
                    importStatus.textContent = `解析完成，共发现 ${importedData.length} 条记录`;
                    
                    // 显示确认按钮
                    confirmImportBtn.classList.remove('hidden');
                    
                } catch (error) {
                    showNotification('error', `解析文件失败：${error.message}`);
                    resetImportModal();
                }
            };
            
            reader.onerror = function() {
                showNotification('error', '读取文件失败');
                resetImportModal();
            };
            
            reader.readAsText(file);
        }
        
        // 处理导入的数据
        function processImportedData() {
            const progressBar = document.getElementById('progressBar');
            const importStatus = document.getElementById('importStatus');
            const confirmImportBtn = document.getElementById('confirmImportBtn');
            
            progressBar.style.width = '0%';
            importStatus.textContent = '开始导入...';
            confirmImportBtn.classList.add('hidden');
            
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            // 分批处理导入，避免UI阻塞
            const batchSize = 10;
            let currentIndex = 0;
            
            function processBatch() {
                const endIndex = Math.min(currentIndex + batchSize, importedData.length);
                
                for (let i = currentIndex; i < endIndex; i++) {
                    try {
                        const row = importedData[i];
                        
                        // 验证月份
                        const month = parseInt(row.month);
                        if (isNaN(month) || month < 1 || month > 12) {
                            throw new Error(`无效的月份: ${row.month}`);
                        }
                        
                        // 验证日期
                        const day = parseInt(row.day);
                        if (isNaN(day) || day < 1 || day > 31) {
                            throw new Error(`无效的日期: ${row.day}`);
                        }
                        
                        // 验证必要字段
                        if (!row.customer) throw new Error('客户名称不能为空');
                        if (!row.project) throw new Error('服务项目不能为空');
                        if (!row.beautician) throw new Error('美容师不能为空');
                        if (!row.channel) throw new Error('到点途径不能为空');
                        
                        // 验证金额
                        const amount = parseFloat(row.amount);
                        if (isNaN(amount) || amount <= 0) {
                            throw new Error(`无效的金额: ${row.amount}`);
                        }
                        
                        // 处理可选字段
                        const manualFee = row.manualFee ? parseFloat(row.manualFee) : null;
                        const performance = row.performance ? parseFloat(row.performance) : null;
                        
                        // 创建记录对象
                        const record = {
                            "日期": `${month}.${day}`,
                            "客户名称": row.customer,
                            "项目": row.project,
                            "美容师": row.beautician,
                            "到点途径": row.channel,
                            "手工费": manualFee,
                            "业绩": performance,
                            "金额": amount
                        };
                        
                        // 添加到相应月份
                        yearBusinessData[month].push(record);
                        successCount++;
                        
                    } catch (error) {
                        errorCount++;
                        errors.push(`第 ${i+1} 行: ${error.message}`);
                    }
                }
                
                currentIndex = endIndex;
                const progress = Math.round((currentIndex / importedData.length) * 100);
                progressBar.style.width = `${progress}%`;
                importStatus.textContent = `已导入 ${currentIndex}/${importedData.length} 条记录`;
                
                if (currentIndex < importedData.length) {
                    setTimeout(processBatch, 50);
                } else {
                    // 导入完成
                    progressBar.style.width = '100%';
                    importStatus.textContent = `导入完成：成功 ${successCount} 条，失败 ${errorCount} 条`;
                    
                    // 保存数据
                    saveDataToLocalStorage();
                    
                    // 刷新界面
                    renderTableData();
                    updateOverviewData();
                    updateBeauticianStats();
                    updateCustomerRanking();
                    updateCharts();
                    
                    // 显示结果通知
                    if (errorCount > 0) {
                        showNotification('info', `导入完成，成功 ${successCount} 条，失败 ${errorCount} 条`);
                        console.log('导入错误详情:', errors);
                    } else {
                        showNotification('success', `成功导入 ${successCount} 条记录`);
                    }
                    
                    // 关闭模态框
                    setTimeout(() => {
                        document.getElementById('importModal').classList.add('hidden');
                        resetImportModal();
                    }, 1500);
                }
            }
            
            // 开始处理
            processBatch();
        }
        
        // 重置导入模态框
        function resetImportModal() {
            document.getElementById('fileInput').value = '';
            document.getElementById('importProgress').classList.add('hidden');
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('importStatus').textContent = '准备导入...';
            document.getElementById('confirmImportBtn').classList.add('hidden');
            importedData = [];
        }
        
        // 导出指定月份数据
        function exportData(month) {
            const data = yearBusinessData[month] || [];
            if (data.length === 0) {
                showNotification('info', `第 ${month} 月没有可导出的数据`);
                return;
            }
            
            // 构建CSV内容
            let csvContent = "月份,日期,客户名称,服务项目,美容师,到点途径,手工费,业绩,金额\n";
            
            data.forEach(record => {
                // 拆分日期为月和日
                const [m, d] = record.日期.split('.');
                
                const row = [
                    m, // 月份
                    d, // 日期
                    `"${record.客户名称.replace(/"/g, '""')}"`, // 客户名称
                    `"${record.项目.replace(/"/g, '""')}"`, // 服务项目
                    record.美容师, // 美容师
                    record.到点途径, // 到点途径
                    record.手工费 || '', // 手工费
                    record.业绩 || '', // 业绩
                    record.金额 // 金额
                ];
                
                csvContent += row.join(',') + "\n";
            });
            
            // 创建并下载文件
            downloadCSV(csvContent, `业务数据_${month}月.csv`);
        }
        
        // 导出全年数据
        function exportAllData() {
            // 构建CSV内容
            let csvContent = "月份,日期,客户名称,服务项目,美容师,到点途径,手工费,业绩,金额\n";
            let totalRecords = 0;
            
            // 遍历所有月份
            for (let month = 1; month <= 12; month++) {
                const data = yearBusinessData[month] || [];
                totalRecords += data.length;
                
                data.forEach(record => {
                    // 拆分日期为月和日
                    const [m, d] = record.日期.split('.');
                    
                    const row = [
                        m, // 月份
                        d, // 日期
                        `"${record.客户名称.replace(/"/g, '""')}"`, // 客户名称
                        `"${record.项目.replace(/"/g, '""')}"`, // 服务项目
                        record.美容师, // 美容师
                        record.到点途径, // 到点途径
                        record.手工费 || '', // 手工费
                        record.业绩 || '', // 业绩
                        record.金额 // 金额
                    ];
                    
                    csvContent += row.join(',') + "\n";
                });
            }
            
            if (totalRecords === 0) {
                showNotification('info', '没有可导出的全年数据');
                return;
            }
            
            // 创建并下载文件
            downloadCSV(csvContent, `业务数据_全年.csv`);
        }
        
        // 下载CSV文件
        function downloadCSV(content, filename) {
            try {
                const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
                
                // 处理不同浏览器的下载
                if (navigator.msSaveBlob) { // IE 10+
                    navigator.msSaveBlob(blob, filename);
                } else {
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    
                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = 'hidden';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                
                showNotification('success', `文件已导出: ${filename}`);
            } catch (error) {
                console.error('导出文件失败:', error);
                showNotification('error', '导出文件失败，请重试');
            }
        }
        
        // 绑定记录表单事件
        function bindRecordFormEvents() {
            // 关闭记录模态框
            document.getElementById('closeRecordModal').addEventListener('click', closeRecordModal);
            document.getElementById('cancelRecordBtn').addEventListener('click', closeRecordModal);
            
            // 提交记录表单
            document.getElementById('recordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveRecord();
            });
        }
        
        // 打开记录模态框
        function openRecordModal(index) {
            const modal = document.getElementById('recordModal');
            const title = document.getElementById('recordModalTitle');
            const recordIndex = document.getElementById('recordIndex');
            const recordMonth = document.getElementById('recordMonth');
            const recordDate = document.getElementById('recordDate');
            
            // 确保模态框DOM元素存在
            if (!modal) {
                console.error('记录模态框不存在');
                return;
            }
            
            // 设置当前月份
            recordMonth.value = currentMonth;
            
            // 清空表单
            document.getElementById('recordForm').reset();
            
            // 设置默认日期为当前月份的今天
            const today = new Date();
            const defaultDate = `${today.getFullYear()}-${String(currentMonth).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            recordDate.value = defaultDate;
            
            if (index === -1) {
                // 新增记录
                title.textContent = '新增业务记录';
                recordIndex.value = -1;
            } else {
                // 编辑现有记录
                title.textContent = '编辑业务记录';
                recordIndex.value = index;
                
                const data = getFilteredData();
                const record = data[index];
                
                if (record) {
                    // 填充表单数据
                    const [month, day] = record.日期.split('.');
                    const date = `${today.getFullYear()}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    recordDate.value = date;
                    document.getElementById('recordCustomer').value = record.客户名称;
                    document.getElementById('recordProject').value = record.项目;
                    document.getElementById('recordBeautician').value = record.美容师;
                    document.getElementById('recordChannel').value = record.到点途径;
                    document.getElementById('recordManualFee').value = record.手工费 || '';
                    document.getElementById('recordPerformance').value = record.业绩 || '';
                    document.getElementById('recordAmount').value = record.金额 || '';
                }
            }
            
            // 显示模态框并添加动画
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('div[class*="bg-white"]').classList.add('scale-100');
                modal.querySelector('div[class*="bg-white"]').classList.remove('scale-95');
            }, 10);
        }
        
        // 关闭记录模态框
        function closeRecordModal() {
            const modal = document.getElementById('recordModal');
            const modalContent = modal.querySelector('div[class*="bg-white"]');
            
            // 添加关闭动画
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }
        
        // 保存记录
        function saveRecord() {
            try {
                const index = parseInt(document.getElementById('recordIndex').value);
                const month = parseInt(document.getElementById('recordMonth').value);
                
                // 获取表单数据
                const date = document.getElementById('recordDate').value;
                const customer = document.getElementById('recordCustomer').value;
                const project = document.getElementById('recordProject').value;
                const beautician = document.getElementById('recordBeautician').value;
                const channel = document.getElementById('recordChannel').value;
                const manualFee = document.getElementById('recordManualFee').value ? parseFloat(document.getElementById('recordManualFee').value) : null;
                const performance = document.getElementById('recordPerformance').value ? parseFloat(document.getElementById('recordPerformance').value) : null;
                const amount = parseFloat(document.getElementById('recordAmount').value);
                
                // 验证必填字段
                if (!date || !customer || !project || !beautician || !channel || isNaN(amount)) {
                    showNotification('error', '请填写所有必填字段');
                    return;
                }
                
                // 格式化日期为 "月.日" 格式
                const dateParts = date.split('-');
                const formattedDate = `${parseInt(dateParts[1])}.${parseInt(dateParts[2])}`;
                
                // 创建记录对象
                const record = {
                    "日期": formattedDate,
                    "客户名称": customer,
                    "项目": project,
                    "美容师": beautician,
                    "到点途径": channel,
                    "手工费": manualFee,
                    "业绩": performance,
                    "金额": amount
                };
                
                if (index === -1) {
                    // 新增记录
                    yearBusinessData[month].push(record);
                    showNotification('success', '记录添加成功');
                } else {
                    // 更新现有记录
                    const data = getFilteredData();
                    const originalIndex = yearBusinessData[month].findIndex(item => 
                        item.日期 === data[index].日期 &&
                        item.客户名称 === data[index].客户名称 &&
                        item.项目 === data[index].项目
                    );
                    
                    if (originalIndex !== -1) {
                        yearBusinessData[month][originalIndex] = record;
                        showNotification('success', '记录更新成功');
                    }
                }
                
                // 保存数据到本地存储
                saveDataToLocalStorage();
                
                // 关闭模态框并刷新数据
                closeRecordModal();
                renderTableData();
                updateOverviewData();
                updateBeauticianStats();
                updateCustomerRanking();
                updateCharts();
            } catch (error) {
                console.error('保存记录失败:', error);
                showNotification('error', '保存记录失败，请重试');
            }
        }
        
        // 更新月份视图
        function updateMonthView(month) {
            try {
                currentMonth = month;
                currentPage = 1;
                
                // 更新月份按钮样式
                document.querySelectorAll('.month-btn').forEach(btn => {
                    if (parseInt(btn.dataset.month) === currentMonth) {
                        btn.classList.add('month-active');
                        btn.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    } else {
                        btn.classList.remove('month-active');
                        btn.classList.add('bg-gray-100', 'hover:bg-gray-200');
                    }
                });
                
                // 渲染表格数据
                renderTableData();
                
                // 更新概览数据
                updateOverviewData();
                
                // 更新美容师业绩统计
                updateBeauticianStats();
                
                // 更新客户排名
                updateCustomerRanking();
                
                // 更新图表
                updateCharts();
            } catch (error) {
                console.error('更新月份视图失败:', error);
                showNotification('error', '切换月份失败，请重试');
            }
        }
        
        // 渲染表格数据
        function renderTableData() {
            const tableBody = document.getElementById('tableBody');
            const data = getFilteredData();
            
            // 更新总记录数
            document.getElementById('totalItems').textContent = data.length;
            
            // 计算分页
            const totalPages = Math.ceil(data.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, data.length);
            const paginatedData = data.slice(startIndex, endIndex);
            
            // 更新当前页范围显示
            document.getElementById('currentPageRange').textContent = 
                `${startIndex + 1} 到 ${endIndex}`;
            
            // 清空表格
            tableBody.innerHTML = '';
            
            // 添加数据行
            if (paginatedData.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="9" class="px-4 py-8 text-center text-gray-500">
                                      没有找到匹配的记录
                                    </td>`;
                tableBody.appendChild(emptyRow);
            } else {
                paginatedData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50 cell-transition';
                    
                    const originalIndex = data.findIndex(d => 
                        d.日期 === item.日期 && 
                        d.客户名称 === item.客户名称 && 
                        d.项目 === item.项目
                    );
                    
                    row.innerHTML = `
                        <td class="px-4 py-3">${item.日期}</td>
                        <td class="px-4 py-3">${item.客户名称}</td>
                        <td class="px-4 py-3">${item.项目}</td>
                        <td class="px-4 py-3">${item.美容师}</td>
                        <td class="px-4 py-3">${item.到点途径}</td>
                        <td class="px-4 py-3">${item.手工费 !== null ? '¥' + item.手工费 : '-'}</td>
                        <td class="px-4 py-3">${item.业绩 !== null ? '¥' + item.业绩 : '-'}</td>
                        <td class="px-4 py-3 font-medium">¥${item.金额}</td>
                        <td class="px-4 py-3">
                            <div class="flex space-x-2">
                                <button class="edit-btn text-primary hover:text-primary/80" 
                                        data-index="${originalIndex}">
                                    <i class="fa fa-pencil"></i>
                                </button>
                                <button class="delete-btn text-red-500 hover:text-red-700" 
                                        data-index="${originalIndex}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }
            
            // 渲染分页控件
            renderPagination(totalPages);
            
            // 绑定编辑和删除按钮事件
            bindTableActionButtons();
        }
        
        // 显示通知
        function showNotification(type, message) {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const text = document.getElementById('notificationText');
            
            // 设置通知类型
            if (type === 'success') {
                notification.className = 'fixed bottom-6 right-6 px-6 py-4 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 flex items-center max-w-xs bg-green-50 border-l-4 border-green-500';
                icon.className = 'fa fa-check-circle mr-3 text-xl text-green-500';
            } else if (type === 'error') {
                notification.className = 'fixed bottom-6 right-6 px-6 py-4 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 flex items-center max-w-xs bg-red-50 border-l-4 border-red-500';
                icon.className = 'fa fa-exclamation-circle mr-3 text-xl text-red-500';
            } else if (type === 'info') {
                notification.className = 'fixed bottom-6 right-6 px-6 py-4 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 flex items-center max-w-xs bg-blue-50 border-l-4 border-blue-500';
                icon.className = 'fa fa-info-circle mr-3 text-xl text-blue-500';
            }
            
            // 设置通知内容
            text.textContent = message;
            
            // 3秒后隐藏通知
            setTimeout(() => {
                notification.className = 'fixed bottom-6 right-6 px-6 py-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center max-w-xs';
            }, 3000);
        }
        
        // 保存数据到本地存储
        function saveDataToLocalStorage() {
            localStorage.setItem('staffData', JSON.stringify(staffData));
            localStorage.setItem('yearBusinessData', JSON.stringify(yearBusinessData));
        }
        
        // 绑定表格操作按钮事件
        function bindTableActionButtons() {
            // 编辑按钮
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    openRecordModal(index);
                });
            });
            
            // 删除按钮
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    if (confirm('确定要删除这条记录吗？')) {
                        deleteRecord(index);
                    }
                });
            });
        }
        
        // 删除记录
        function deleteRecord(index) {
            const data = getFilteredData();
            const recordToDelete = data[index];
            
            // 找到原始数据中的索引
            const originalIndex = yearBusinessData[currentMonth].findIndex(item => 
                item.日期 === recordToDelete.日期 &&
                item.客户名称 === recordToDelete.客户名称 &&
                item.项目 === recordToDelete.项目
            );
            
            if (originalIndex !== -1) {
                yearBusinessData[currentMonth].splice(originalIndex, 1);
                
                // 保存数据
                saveDataToLocalStorage();
                
                // 刷新表格
                renderTableData();
                
                // 更新统计数据
                updateOverviewData();
                updateBeauticianStats();
                updateCustomerRanking();
                updateCharts();
                
                showNotification('success', '记录已删除');
            }
        }
        
        // 填充美容师选择框
        function populateBeauticianSelects() {
            const select = document.getElementById('recordBeautician');
            select.innerHTML = '<option value="">请选择美容师</option>';
            
            // 筛选出美容师和理疗师
            const beauticians = staffData.filter(staff => 
                staff.position === '美容师' || staff.position === '理疗师'
            );
            
            beauticians.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.name;
                option.textContent = staff.name;
                select.appendChild(option);
            });
        }
        
        // 渲染员工列表
        function renderStaffList() {
            const staffListEl = document.getElementById('staffList');
            staffListEl.innerHTML = '';
            
            // 筛选出美容师和理疗师
            const beauticians = staffData.filter(staff => 
                staff.position === '美容师' || staff.position === '理疗师'
            );
            
            if (beauticians.length === 0) {
                const emptyItem = document.createElement('li');
                emptyItem.className = 'text-center text-gray-500 py-2';
                emptyItem.textContent = '暂无员工数据';
                staffListEl.appendChild(emptyItem);
            } else {
                beauticians.forEach(staff => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-2 hover:bg-gray-50 rounded';
                    li.innerHTML = `
                        <span>${staff.name} (${staff.position})</span>
                        <button class="delete-staff text-red-500 hover:text-red-700" data-id="${staff.id}">
                            <i class="fa fa-times"></i>
                        </button>
                    `;
                    staffListEl.appendChild(li);
                });
            }
            
            // 绑定删除员工事件
            document.querySelectorAll('.delete-staff').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.dataset.id);
                    deleteStaff(id);
                });
            });
        }
        
        // 绑定分页事件
        function bindPaginationEvents() {
            document.getElementById('prevPage').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    renderTableData();
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', function() {
                const totalPages = Math.ceil(getFilteredData().length / pageSize);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTableData();
                }
            });
            
            document.getElementById('prevPageMobile').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    renderTableData();
                }
            });
            
            document.getElementById('nextPageMobile').addEventListener('click', function() {
                const totalPages = Math.ceil(getFilteredData().length / pageSize);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTableData();
                }
            });
        }
        
        // 绑定搜索事件
        function bindSearchEvent() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                searchKeyword = this.value.trim();
                currentPage = 1; // 重置到第一页
                renderTableData();
            });
        }
        
        // 绑定员工管理事件
        function bindStaffManagementEvents() {
            const staffBtn = document.getElementById('staffBtn');
            const staffModal = document.getElementById('staffModal');
            const closeStaffModal = document.getElementById('closeStaffModal');
            const addStaffBtn = document.getElementById('addStaffBtn');
            const staffForm = document.getElementById('staffForm');
            const cancelStaffBtn = document.getElementById('cancelStaffBtn');
            const saveStaffBtn = document.getElementById('saveStaffBtn');
            
            // 打开员工管理模态框
            staffBtn.addEventListener('click', function() {
                staffModal.classList.remove('hidden');
                staffForm.classList.add('hidden');
            });
            
            // 关闭员工管理模态框
            closeStaffModal.addEventListener('click', function() {
                staffModal.classList.add('hidden');
                staffForm.reset();
            });
            
            // 显示添加员工表单
            addStaffBtn.addEventListener('click', function() {
                staffForm.classList.remove('hidden');
                staffForm.reset();
            });
            
            // 取消添加员工
            cancelStaffBtn.addEventListener('click', function() {
                staffForm.classList.add('hidden');
                staffForm.reset();
            });
            
            // 保存员工
            saveStaffBtn.addEventListener('click', function() {
                const name = document.getElementById('staffName').value.trim();
                const position = document.getElementById('staffPosition').value;
                
                if (!name) {
                    showNotification('error', '请输入员工姓名');
                    return;
                }
                
                // 创建新员工
                const newStaff = {
                    id: Date.now(), // 使用时间戳作为唯一ID
                    name: name,
                    position: position
                };
                
                // 添加到员工数据
                staffData.push(newStaff);
                
                // 保存数据
                saveDataToLocalStorage();
                
                // 更新员工列表和美容师选择框
                renderStaffList();
                populateBeauticianSelects();
                
                // 隐藏表单
                staffForm.classList.add('hidden');
                staffForm.reset();
                
                showNotification('success', '员工添加成功');
            });
        }
        
        // 删除员工
        function deleteStaff(id) {
            if (confirm('确定要删除该员工吗？相关记录不会被删除。')) {
                // 从员工数据中删除
                staffData = staffData.filter(staff => staff.id !== id);
                
                // 保存数据
                saveDataToLocalStorage();
                
                // 更新员工列表和美容师选择框
                renderStaffList();
                populateBeauticianSelects();
                
                showNotification('success', '员工已删除');
            }
        }
        
        // 绑定保存数据按钮事件
        function bindSaveDataButton() {
            document.getElementById('saveBtn').addEventListener('click', function() {
                saveDataToLocalStorage();
                showNotification('success', '数据已保存');
            });
        }
        
        // 初始化图表
        function initCharts() {
            // 业务类型分布图表
            const serviceTypeCtx = document.getElementById('serviceTypeChart').getContext('2d');
            window.serviceTypeChart = new Chart(serviceTypeCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#A23B72', '#2E86AB', '#F18F01', 
                            '#4CAF50', '#FF5722', '#9C27B0'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
            
            // 月度趋势图表
            const monthlyTrendCtx = document.getElementById('monthlyTrendChart').getContext('2d');
            window.monthlyTrendChart = new Chart(monthlyTrendCtx, {
                type: 'line',
                data: {
                    labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                    datasets: [{
                        label: '营业额',
                        data: new Array(12).fill(0),
                        borderColor: '#A23B72',
                        backgroundColor: 'rgba(162, 59, 114, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value;
                                }
                            }
                        }
                    }
                }
            });
            
            // 到点途径分布图表
            const arrivalChannelCtx = document.getElementById('arrivalChannelChart').getContext('2d');
            window.arrivalChannelChart = new Chart(arrivalChannelCtx, {
                type: 'pie',
                data: {
                    labels: arrivalChannels,
                    datasets: [{
                        data: new Array(arrivalChannels.length).fill(0),
                        backgroundColor: [
                            '#A23B72', '#2E86AB', '#F18F01'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Top5客户消费占比图表
            const topCustomersCtx = document.getElementById('topCustomersChart').getContext('2d');
            window.topCustomersChart = new Chart(topCustomersCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#A23B72', '#2E86AB', '#F18F01', '#4CAF50', '#FF5722'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // 更新所有图表
        function updateCharts() {
            updateServiceTypeChart();
            updateMonthlyTrendChart();
            updateArrivalChannelChart();
        }
        
        function updateServiceTypeChart() {
            if (!window.serviceTypeChart) return;
            
            const currentData = yearBusinessData[currentMonth] || [];
            const projectStats = {};
            
            // 拆分项目并统计
            currentData.forEach(item => {
                const projects = item.项目.split(',').map(p => p.trim()).filter(p => p);
                projects.forEach(project => {
                    if (!projectStats[project]) {
                        projectStats[project] = 0;
                    }
                    projectStats[project] += 1;
                });
            });
            
            // 更新图表数据
            const labels = Object.keys(projectStats);
            const data = Object.values(projectStats);
            
            window.serviceTypeChart.data.labels = labels;
            window.serviceTypeChart.data.datasets[0].data = data;
            window.serviceTypeChart.update();
        }
        
        function updateMonthlyTrendChart() {
            if (!window.monthlyTrendChart) return;
            
            // 计算每个月的营业额
            const monthlyData = [];
            for (let i = 1; i <= 12; i++) {
                const revenue = (yearBusinessData[i] || []).reduce((sum, item) => sum + (item.金额 || 0), 0);
                monthlyData.push(revenue);
            }
            
            window.monthlyTrendChart.data.datasets[0].data = monthlyData;
            window.monthlyTrendChart.update();
        }
        
        function updateArrivalChannelChart() {
            if (!window.arrivalChannelChart) return;
            
            const currentData = yearBusinessData[currentMonth] || [];
            const channelStats = arrivalChannels.reduce((obj, channel) => {
                obj[channel] = 0;
                return obj;
            }, {});
            
            currentData.forEach(item => {
                if (channelStats.hasOwnProperty(item.到点途径)) {
                    channelStats[item.到点途径] += 1;
                }
            });
            
            window.arrivalChannelChart.data.datasets[0].data = arrivalChannels.map(channel => channelStats[channel]);
            window.arrivalChannelChart.update();
        }
        
        // 获取筛选后的数据
        function getFilteredData() {
            let data = yearBusinessData[currentMonth] || [];
            
            // 应用搜索过滤
            if (searchKeyword) {
                const keyword = searchKeyword.toLowerCase();
                data = data.filter(item => 
                    item.客户名称.toLowerCase().includes(keyword) ||
                    item.项目.toLowerCase().includes(keyword) ||
                    item.美容师.toLowerCase().includes(keyword) ||
                    item.到点途径.toLowerCase().includes(keyword)
                );
            }
            
            return data;
        }
        
        // 渲染分页控件
        function renderPagination(totalPages) {
            const paginationContainer = document.getElementById('paginationNumbers');
            paginationContainer.innerHTML = '';
            
            // 控制上一页按钮状态
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('prevPageMobile').disabled = currentPage === 1;
            if (currentPage === 1) {
                document.getElementById('prevPage').classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('prevPageMobile').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                document.getElementById('prevPage').classList.remove('opacity-50', 'cursor-not-allowed');
                document.getElementById('prevPageMobile').classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            // 控制下一页按钮状态
            document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
            document.getElementById('nextPageMobile').disabled = currentPage === totalPages || totalPages === 0;
            if (currentPage === totalPages || totalPages === 0) {
                document.getElementById('nextPage').classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('nextPageMobile').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                document.getElementById('nextPage').classList.remove('opacity-50', 'cursor-not-allowed');
                document.getElementById('nextPageMobile').classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // 更新概览数据
        function updateOverviewData() {
            const currentData = yearBusinessData[currentMonth] || [];
            
            // 本月记录数
            document.getElementById('monthRecords').textContent = currentData.length;
            
            // 本月客户数（去重）
            const monthCustomers = [...new Set(currentData.map(item => item.客户名称))];
            document.getElementById('monthCustomers').textContent = monthCustomers.length;
            
            // 客户总数（全年去重）
            let allCustomers = [];
            for (let month in yearBusinessData) {
                allCustomers = [...allCustomers, ...yearBusinessData[month].map(item => item.客户名称)];
            }
            const uniqueCustomers = [...new Set(allCustomers)];
            document.getElementById('totalCustomers').textContent = uniqueCustomers.length;
            
            // 服务次数（本月）
            const serviceCount = currentData.reduce((count, item) => {
                // 按逗号分割项目并计算总数
                const items = item.项目.split(',').filter(i => i.trim() !== '');
                return count + items.length;
            }, 0);
            document.getElementById('totalServices').textContent = serviceCount + '+';
            
            // 月营业额
            const monthRevenue = currentData.reduce((sum, item) => sum + (item.金额 || 0), 0);
            document.getElementById('monthRevenue').textContent = '¥' + monthRevenue.toFixed(2);
            
            // 年总营业额
            let yearRevenue = 0;
            for (let month in yearBusinessData) {
                yearRevenue += yearBusinessData[month].reduce((sum, item) => sum + (item.金额 || 0), 0);
            }
            document.getElementById('yearRevenue').textContent = '¥' + yearRevenue.toFixed(2);
            
            // 月营业额变化（较上月）
            const prevMonth = currentMonth > 1 ? currentMonth - 1 : 12;
            const prevMonthRevenue = (yearBusinessData[prevMonth] || []).reduce((sum, item) => sum + (item.金额 || 0), 0);
            
            const revenueChangeEl = document.getElementById('monthRevenueChange');
            if (prevMonthRevenue === 0) {
                revenueChangeEl.innerHTML = '<i class="fa fa-arrow-up mr-1"></i> 较上月增长100%';
                revenueChangeEl.className = 'mt-4 text-sm text-green-600 flex items-center';
            } else {
                const changePercent = ((monthRevenue - prevMonthRevenue) / prevMonthRevenue) * 100;
                if (changePercent >= 0) {
                    revenueChangeEl.innerHTML = `<i class="fa fa-arrow-up mr-1"></i> 较上月增长${changePercent.toFixed(1)}%`;
                    revenueChangeEl.className = 'mt-4 text-sm text-green-600 flex items-center';
                } else {
                    revenueChangeEl.innerHTML = `<i class="fa fa-arrow-down mr-1"></i> 较上月下降${Math.abs(changePercent).toFixed(1)}%`;
                    revenueChangeEl.className = 'mt-4 text-sm text-red-600 flex items-center';
                }
            }
        }
        
        // 更新美容师业绩统计
        function updateBeauticianStats() {
            const currentData = yearBusinessData[currentMonth] || [];
            const statsBody = document.getElementById('beauticianStatsBody');
            statsBody.innerHTML = '';
            
            // 按美容师分组统计
            const stats = {};
            
            currentData.forEach(item => {
                const name = item.美容师;
                if (!stats[name]) {
                    stats[name] = {
                        totalManualFee: 0,
                        totalPerformance: 0,
                        serviceCount: 0
                    };
                }
                
                stats[name].totalManualFee += item.手工费 || 0;
                stats[name].totalPerformance += item.业绩 || 0;
                stats[name].serviceCount += 1;
            });
            
            // 生成统计行
            for (const name in stats) {
                const stat = stats[name];
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50 cell-transition';
                row.innerHTML = `
                    <td class="px-4 py-3">${name}</td>
                    <td class="px-4 py-3">¥${stat.totalManualFee.toFixed(2)}</td>
                    <td class="px-4 py-3">¥${stat.totalPerformance.toFixed(2)}</td>
                    <td class="px-4 py-3">${stat.serviceCount}</td>
                `;
                statsBody.appendChild(row);
            }
            
            // 如果没有数据
            if (Object.keys(stats).length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                      本月暂无业绩数据
                                    </td>`;
                statsBody.appendChild(emptyRow);
            }
        }
        
        // 更新客户排名
        function updateCustomerRanking() {
            const rankingBody = document.getElementById('customerRankingBody');
            rankingBody.innerHTML = '';
            
            // 计算全年客户消费统计
            const customerStats = {};
            
            for (let month in yearBusinessData) {
                yearBusinessData[month].forEach(item => {
                    const name = item.客户名称;
                    if (!customerStats[name]) {
                        customerStats[name] = {
                            totalSpending: 0,
                            visitCount: 0
                        };
                    }
                    
                    customerStats[name].totalSpending += item.金额 || 0;
                    customerStats[name].visitCount += 1;
                });
            }
            
            // 转换为数组并按消费总额排序
            const sortedCustomers = Object.entries(customerStats)
                .map(([name, stats]) => ({
                    name,
                    totalSpending: stats.totalSpending,
                    visitCount: stats.visitCount,
                    avgSpending: stats.totalSpending / stats.visitCount
                }))
                .sort((a, b) => b.totalSpending - a.totalSpending);
            
            // 生成排名行（前10名）
            const topCustomers = sortedCustomers.slice(0, 10);
            topCustomers.forEach((customer, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50 cell-transition';
                
                // 排名徽章颜色
                let badgeColor = 'bg-gray-500';
                if (index === 0) badgeColor = 'bg-yellow-500'; // 第一名金色
                else if (index === 1) badgeColor = 'bg-gray-400'; // 第二名银色
                else if (index === 2) badgeColor = 'bg-yellow-700'; // 第三名铜色
                
                row.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="rank-badge ${badgeColor}">${index + 1}</div>
                    </td>
                    <td class="px-4 py-3">${customer.name}</td>
                    <td class="px-4 py-3 font-medium">¥${customer.totalSpending.toFixed(2)}</td>
                    <td class="px-4 py-3">${customer.visitCount}</td>
                    <td class="px-4 py-3">¥${customer.avgSpending.toFixed(2)}</td>
                `;
                rankingBody.appendChild(row);
            });
            
            // 如果没有数据
            if (sortedCustomers.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                      暂无客户消费数据
                                    </td>`;
                rankingBody.appendChild(emptyRow);
            }
            
            // 更新Top5客户图表
            updateTopCustomersChart(topCustomers.slice(0, 5));
        }
        
        // 更新Top5客户图表
        function updateTopCustomersChart(topCustomers) {
            if (!window.topCustomersChart) return;
            
            window.topCustomersChart.data.labels = topCustomers.map(c => c.name);
            window.topCustomersChart.data.datasets[0].data = topCustomers.map(c => c.totalSpending);
            window.topCustomersChart.update();
        }
    </script>
</body>
</html>
